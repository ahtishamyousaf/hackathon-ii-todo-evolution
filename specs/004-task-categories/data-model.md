# Data Model: Task Categories System

**Feature**: 004-task-categories
**Date**: 2025-12-24
**Purpose**: Define database schema, entities, and relationships for category system

## Entity Definitions

### Category

**Purpose**: Represents a user-defined organizational group for tasks

**Attributes**:
- `id` (integer, primary key, auto-increment)
  - Unique identifier for the category
  - Generated by database sequence

- `name` (string, max 50 characters, required)
  - Display name of the category
  - Examples: "Work", "Personal", "Shopping"
  - Must be unique per user (enforced by constraint)
  - Validation: 1-50 characters, trimmed

- `color` (string, 7 characters, optional)
  - Visual color code in hex format
  - Format: `#RRGGBB` (e.g., "#FF5733")
  - Default: `#9CA3AF` (neutral gray)
  - Validation: Regex pattern `^#[0-9A-Fa-f]{6}$`

- `user_id` (integer, foreign key, required)
  - Owner of the category
  - References: `users.id`
  - Cascade: ON DELETE CASCADE (category deleted when user deleted)
  - Indexed for fast lookups

- `created_at` (timestamp, required)
  - When category was created
  - Default: Current timestamp (UTC)
  - Immutable after creation

- `updated_at` (timestamp, required)
  - Last modification timestamp
  - Default: Current timestamp (UTC)
  - Auto-updated on any field change

**Constraints**:
- PRIMARY KEY: `id`
- UNIQUE: `(user_id, name)` - each user has unique category names
- FOREIGN KEY: `user_id` REFERENCES `users(id)` ON DELETE CASCADE
- CHECK: `LENGTH(name) >= 1 AND LENGTH(name) <= 50`
- CHECK: `color ~ '^#[0-9A-Fa-f]{6}$'` OR `color IS NULL`

**Indexes**:
- `idx_categories_user` on `user_id` (for fast category list retrieval)
- Implicit index on `(user_id, name)` from UNIQUE constraint

---

### Task (Modified)

**Purpose**: Existing task entity, extended with category relationship

**New Attribute**:
- `category_id` (integer, foreign key, optional)
  - Category this task belongs to
  - NULL = uncategorized task
  - References: `categories.id`
  - Cascade: ON DELETE SET NULL (task preserved, category removed)
  - Indexed for fast filtering

**Constraints Added**:
- FOREIGN KEY: `category_id` REFERENCES `categories(id)` ON DELETE SET NULL

**Indexes Added**:
- `idx_tasks_category` on `category_id` (for fast category filtering)

**Existing Attributes** (unchanged):
- `id`, `title`, `description`, `completed`, `user_id`, `created_at`, `updated_at`

---

## Relationships

```
User (1) ──────────────┐
            │           │
            │ has many  │
            ▼           │
        Category (N)    │ owns
            │           │
            │ has many  │
            ▼           ▼
         Task (N) ─────────┘
```

### User → Category (One-to-Many)
- One user can have many categories
- Each category belongs to exactly one user
- Cardinality: 1:N
- Delete behavior: Cascade (deleting user deletes all their categories)

### Category → Task (One-to-Many, Optional)
- One category can have many tasks
- Each task belongs to zero or one category
- Cardinality: 1:N (optional on task side)
- Delete behavior: SET NULL (deleting category un-categorizes tasks)

### User → Task (One-to-Many)
- One user can have many tasks
- Each task belongs to exactly one user
- Cardinality: 1:N
- Delete behavior: Cascade (deleting user deletes all their tasks)
- **Note**: This relationship existed before categories, unchanged

## Database Schema

### SQL Definition

```sql
-- Table: categories
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL CHECK (LENGTH(name) >= 1 AND LENGTH(name) <= 50),
    color VARCHAR(7) DEFAULT '#9CA3AF' CHECK (color ~ '^#[0-9A-Fa-f]{6}$' OR color IS NULL),
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT unique_category_per_user UNIQUE (user_id, name)
);

-- Indexes for categories
CREATE INDEX idx_categories_user ON categories(user_id);

-- Trigger to auto-update updated_at
CREATE OR REPLACE FUNCTION update_categories_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_categories_updated_at
    BEFORE UPDATE ON categories
    FOR EACH ROW
    EXECUTE FUNCTION update_categories_updated_at();

-- Table: tasks (modification)
ALTER TABLE tasks ADD COLUMN category_id INTEGER NULL;
ALTER TABLE tasks ADD CONSTRAINT fk_task_category
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL;

-- Index for tasks category filtering
CREATE INDEX idx_tasks_category ON tasks(category_id);
```

### SQLModel Definition (Python)

```python
from sqlmodel import SQLModel, Field
from typing import Optional
from datetime import datetime

class Category(SQLModel, table=True):
    """Category model for organizing tasks."""

    __tablename__ = "categories"

    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(max_length=50, min_length=1, index=False)
    color: str = Field(default="#9CA3AF", max_length=7, regex=r"^#[0-9A-Fa-f]{6}$")
    user_id: int = Field(foreign_key="users.id", index=True)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)

    class Config:
        schema_extra = {
            "example": {
                "name": "Work",
                "color": "#3B82F6",
                "user_id": 1
            }
        }

# Schema for creating categories
class CategoryCreate(SQLModel):
    name: str = Field(max_length=50, min_length=1)
    color: Optional[str] = Field(default=None, max_length=7, regex=r"^#[0-9A-Fa-f]{6}$")

# Schema for updating categories
class CategoryUpdate(SQLModel):
    name: Optional[str] = Field(default=None, max_length=50, min_length=1)
    color: Optional[str] = Field(default=None, max_length=7, regex=r"^#[0-9A-Fa-f]{6}$")

# Schema for reading categories
class CategoryRead(SQLModel):
    id: int
    name: str
    color: str
    user_id: int
    created_at: datetime
    updated_at: datetime

# Task model update (add category_id field)
class Task(TaskBase, table=True):
    # ... existing fields ...
    category_id: Optional[int] = Field(default=None, foreign_key="categories.id", index=True)
```

### TypeScript Types (Frontend)

```typescript
// types/category.ts
export interface Category {
  id: number;
  name: string;
  color: string;
  user_id: number;
  created_at: string; // ISO 8601
  updated_at: string; // ISO 8601
}

export interface CategoryCreate {
  name: string;
  color?: string; // Hex code or undefined for default
}

export interface CategoryUpdate {
  name?: string;
  color?: string;
}

// types/task.ts (update)
export interface Task {
  id: number;
  title: string;
  description: string;
  completed: boolean;
  category_id: number | null; // NEW: optional category
  user_id: number;
  created_at: string;
  updated_at: string;
}

export interface TaskCreate {
  title: string;
  description?: string;
  completed?: boolean;
  category_id?: number | null; // NEW: optional category
}
```

## Data Validation Rules

### Category Name
- **Required**: Yes
- **Min Length**: 1 character
- **Max Length**: 50 characters
- **Trimming**: Leading/trailing whitespace removed
- **Uniqueness**: Per user (case-sensitive)
- **Pattern**: No specific pattern, allows all characters

### Category Color
- **Required**: No (defaults to #9CA3AF)
- **Format**: Hex color code `#RRGGBB`
- **Pattern**: `^#[0-9A-Fa-f]{6}$`
- **Normalization**: Uppercase recommended for consistency
- **Examples**: `#FF5733`, `#3B82F6`, `#10B981`

### Category-Task Assignment
- **Optional**: Yes (tasks can be uncategorized)
- **Validation**: If provided, category must exist and belong to current user
- **Cascading**: Deleting category sets task's category_id to NULL

## State Transitions

### Category Lifecycle

```
       CREATE
         ↓
    ┌─────────┐
    │  ACTIVE │ ←──────┐
    └─────────┘        │
         │             │
         │ UPDATE ─────┘
         │
         │ DELETE
         ↓
    ┌─────────┐
    │ DELETED │
    └─────────┘
```

### Task Categorization States

```
┌──────────────┐
│ UNCATEGORIZED│ (category_id = NULL)
└──────────────┘
       │ ↕
       │ ASSIGN / UNASSIGN
       ↓ ↕
┌──────────────┐
│ CATEGORIZED  │ (category_id = X)
└──────────────┘
       │
       │ DELETE CATEGORY
       ↓
┌──────────────┐
│ UNCATEGORIZED│ (category_id = NULL)
└──────────────┘
```

## Query Patterns

### Common Queries

1. **List user's categories**:
```sql
SELECT * FROM categories
WHERE user_id = $1
ORDER BY name ASC;
```

2. **Get tasks by category**:
```sql
SELECT * FROM tasks
WHERE user_id = $1 AND category_id = $2
ORDER BY created_at DESC;
```

3. **Get uncategorized tasks**:
```sql
SELECT * FROM tasks
WHERE user_id = $1 AND category_id IS NULL
ORDER BY created_at DESC;
```

4. **Count tasks per category**:
```sql
SELECT c.id, c.name, COUNT(t.id) as task_count
FROM categories c
LEFT JOIN tasks t ON t.category_id = c.id
WHERE c.user_id = $1
GROUP BY c.id, c.name
ORDER BY c.name ASC;
```

5. **Check category name uniqueness**:
```sql
SELECT EXISTS(
  SELECT 1 FROM categories
  WHERE user_id = $1 AND name = $2 AND id != $3
);
```

## Performance Considerations

### Index Strategy
- **Primary Lookups**: `id` (automatic via PRIMARY KEY)
- **User Filtering**: `user_id` index on categories
- **Category Filtering**: `category_id` index on tasks
- **Uniqueness Check**: Composite index on `(user_id, name)`

### Expected Query Performance
- Category list retrieval: O(log n) via user_id index
- Task filtering by category: O(log n) via category_id index
- Name uniqueness check: O(log n) via composite index

### Scalability Notes
- Handles 50+ categories per user efficiently (indexed lookups)
- Category deletion is fast (SET NULL update on tasks)
- No complex joins required for common operations

## Migration Strategy

### Migration 1: Create Categories Table
```sql
-- File: 002_create_categories_table.sql
CREATE TABLE categories (...);
CREATE INDEX idx_categories_user ON categories(user_id);
CREATE TRIGGER update_categories_updated_at ...;
```

### Migration 2: Add Category to Tasks
```sql
-- File: 003_add_category_to_tasks.sql
ALTER TABLE tasks ADD COLUMN category_id INTEGER NULL;
ALTER TABLE tasks ADD CONSTRAINT fk_task_category ...;
CREATE INDEX idx_tasks_category ON tasks(category_id);
```

### Rollback Strategy
```sql
-- Rollback 003
ALTER TABLE tasks DROP CONSTRAINT fk_task_category;
DROP INDEX idx_tasks_category;
ALTER TABLE tasks DROP COLUMN category_id;

-- Rollback 002
DROP TRIGGER update_categories_updated_at ON categories;
DROP TABLE categories;
```
